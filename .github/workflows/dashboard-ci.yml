name: ğŸ¨ Dashboard CI/CD

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'src/api/**'
      - 'src/auto_detection/**'
      - '.github/workflows/**'
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'src/api/**'
      - 'src/auto_detection/**'

jobs:
  # Frontend Testing
  frontend-test:
    name: ğŸ¨ Frontend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
        
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ” Lint check
      run: npm run lint
      
    - name: ğŸ—ï¸ Build frontend
      run: npm run build
      
    - name: ğŸ“Š Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist

  # Backend Testing  
  backend-test:
    name: ğŸ Backend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Setup uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ğŸ“¥ Install dependencies
      run: uv sync --extra dev
      
    - name: ğŸ§ª Run API tests
      run: uv run pytest tests/unit/test_dashboard_api.py -v
      
    - name: ğŸ” Lint backend code
      run: uv run ruff check src/api/ src/auto_detection/ --fix
      
    - name: ğŸ”§ Test dashboard server startup
      run: |
        timeout 10s uv run python -m uvicorn src.api.dashboard_server:app --host 127.0.0.1 --port 8001 || true
        
  # Integration Testing
  integration-test:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [frontend-test, backend-test]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Setup uv
      uses: astral-sh/setup-uv@v3
      
    - name: ğŸ“¥ Install Python dependencies
      run: uv sync --extra dev
      
    - name: ğŸ“¥ Install Node dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: ğŸš€ Start backend server
      run: |
        uv run python -m uvicorn src.api.dashboard_server:app --host 127.0.0.1 --port 8001 &
        sleep 5
        
    - name: ğŸ—ï¸ Build frontend
      working-directory: ./frontend
      run: npm run build
      
    - name: ğŸ§ª Test API endpoints
      run: |
        curl -f http://127.0.0.1:8001/ || exit 1
        curl -f http://127.0.0.1:8001/api/dashboard/health || exit 1
        
    - name: ğŸ“Š API Response Test
      run: |
        response=$(curl -s http://127.0.0.1:8001/api/dashboard/health)
        echo "Health check response: $response"
        
  # Security Scan
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Run Trivy security scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“Š Upload security scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Deployment Ready Check
  deployment-check:
    name: ğŸš€ Deployment Ready
    runs-on: ubuntu-latest
    needs: [integration-test, security-scan]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: âœ… All checks passed
      run: |
        echo "ğŸ‰ Dashboard is ready for deployment!"
        echo "âœ… Frontend builds successfully"
        echo "âœ… Backend tests pass"
        echo "âœ… Integration tests pass"
        echo "âœ… Security scan clean"
        echo ""
        echo "ğŸš€ Ready to merge and deploy!"